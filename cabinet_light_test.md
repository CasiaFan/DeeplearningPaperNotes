# 魔柜灯光测试

## 双向透光膜（ 透光度35% ）

1. 贴膜+外部光照（开灯）

   ![image1-1](pic/m2_35_1_out.png)

   照度： 268

   ![image1-2](pic/m2_35_3_out.png)

   照度： 304
   ![image1-3](pic/m2_35_4_out.png)
   	
   照度： 136
   	
   ![image1-4](pic/m2_35_5_out.png)
   	
   照度：129
   	
   ![image1-6](pic/m2_35_6_out.png)
   	
   照度： 96



2. 贴膜+外部无光照（关灯）

   照度： 268

   照度： 327

   照度： 154

   照度： 130

   照度： 96

   

3. 贴膜+外部强光

   ![image3-1](pic/m2_35_3_strong.png)

   照度：296

   ![image3-1](pic/m2_35_1_strong.png)

   照度： 318

   ![image3-1](pic/m2_35_4_strong.png)

   照度：169

   ![image3-1](pic/m2_35_6_strong.png)

   照度：136

   ![image3-1](pic/m2_35_5_strong.png)

   照度：103

   

4. 无膜+外部光照（开灯）

   照度：285

   照度： 338

   照度：152

   照度：139

   照度：90

5. 无膜+外部无光（关灯)

   照度：252

   照度：312

   照度：145

   照度：135

   照度：90

6. 无膜+外部强光

   照度：332

   照度：414

   照度：200

   照度：137

   照度：106



## 单向膜（透光度70%）

1. 贴膜+外部光照（开灯）

   照度：272

   照度：339

   照度：149

   照度：126

   照度：93

2. 贴膜+外部强光照

   照度：294

   照度： 348

   照度： 166

   照度：138

   照度：96



### 总结：

1. 平均来看，不贴膜在开灯的情况下，靠近最外侧的照度比最内侧的照度高超过4倍（>340与90）；而在关灯的时候外侧的照度下降最多（30），但对结果影响不大，说明在外部光照正常时影响冰柜内部照明的主要因素还是冰柜内的灯光；但是在外部有强烈光照的时候（打光），外侧的照度变化超过100，而内部则影响不大，此时成像中会出现比较明显的阴影。
2. 贴膜结果来看，测试用的35%透光度的双向膜和70透光度的单向膜都取得了很好的遮光效果，能够将强光对外侧的影响减少到30以内。不过单向膜的反光效果比双向膜更强，在金属灌装饮料放外侧的时候可能会导致误检；此外单向膜需要贴在冰箱内部，操作比双向膜略复杂。总的来说，两种膜都可以满足需要。



# 魔柜灯光测试

1. 顶部外侧平行光源 ：外侧单条灯带，照度200，透光塑料散光（当前）

   视觉效果：

   ![light-1](pic/env1.jpg)

   原始图像：

   ![light-2](pic/env1-init.png)

   gamma矫正后（识别输入图像）：

   ![light-3](pic/env1-gamma.png)

2. 顶部外侧平行光源+内部壁反射光：外侧灯带同上，内侧灯带从隔层向内壁投射，灯带照度200。内部照度从66->75。

   视觉效果：

   ![light-4](pic/env2.jpg)

   原始图像：

   ![light-5](pic/env2-init.png)

   gamma矫正后（识别输入图像）：

   ![light-6](pic/env2-gamma.png)

3. 隔层散射光源：隔层沿小孔周边向上贴灯条，灯带照度200，底层照度20

   视觉效果：

   ![light-7](pic/env3.jpg)

   原始图像：

   ![light-8](pic/env3-init.png)

   gamma矫正后：

   ![light-9](pic/env3-gamma.png)

4. 顶板面光源：灯带平行布置于隔层透光白色塑料，透光照度45

   视觉效果

   ![light-10](pic/env4.jpg)

   原始图像：

   ![light-11](pic/env4-init.jpg)

   gamma矫正：

   ![light-5](pic/env4-gamma.jpg)

**总结**

1. 测试发现海康摄像头有**自动调节亮度**的功能：在暗光条件下（照度20，方案3）和正常光照（照度65，方案1）的原始成像图片差异不大
2. 灯带布置需要避免在物体上方产生局部高亮：在方案4中虽然照度只有45，但是由于灯带在隔层中分布不均造成局部高亮，形成了点光源的效果，在瓶盖上形成了反光。改进措施包括：1. 需要调整灯带位置到平行；2.增加灯带使亮度平均；3 . 降低隔层透光度/降低灯带亮度加强散射效果（当前选用灯带照度为800左右）
3. 从原始图片成像效果来看，方案2的效果最好，但是由于测试用小米灯带的照度太低（200lux），因此内部的增量效果不太明显（66->75）。如果要增强到跟外部一样的效果，估计需要将亮度调高到300左右。
4. 从商品的视觉效果来看，方案1，2的效果最好；虽然方案3的图像不影响检测，但是整体偏暗，商品展示的视觉效果比较差。



# 魔柜量产化灯光部署方案（390版）

### 1. 夹层部署方案

在390版本冰柜的重力夹层中，将长度**50cm**，宽8mm的**12V 2835芯片 60珠/m的防水白光灯带**置于相应长度的**乳白灯罩**内，将**发光面正对覆盖下层的2和3号透光孔**（下层有4排透光孔，由**外到内**编号1-4）。此方案中，摄像头的**曝光参数**需要设这到**5-7**（v4l2-ctl设置）

具体安装如下：

![light_deploy_1](pic/light_deploy_3.jpg)

![light_deploy_2](pic/light_deploy_4.jpg)

视觉效果如下：

![light_deploy_3](pic/light_deploy_2.jpg)

检测输入图像如下：

![light_deploy_4](pic/light_deploy_1.jpg)



# 烟柜灯光测试

条件：130度广角摄像头；摄像头距外边框距离12cm；距烟盒顶部距离11cm；灯带设置在最内侧，高度9cm（一个烟盒的高度）.

1. 外侧平行光源+内侧平行光源无遮挡（最外侧680lux）（零距离1050lux）

![ciga_01](pic/ciga_01.jpg)

2. 外侧平行光源+内侧平行光源有遮挡（最外测190lux）（零距离400lux）

![ciga_02](pic/ciga_02.jpg)

3. 外侧平行光源+内侧无灯光

![ciga_03](pic/ciga_03.jpg)

**总结**：

1. 在外界有点光源存在的情况下，无论内部灯光如何调节均无法完全消除点光源造成的反光，因此在目前的情况下部署需要尽量避免点光源
2. 在打开灯带的情况下基本能够在**外部为平行光时**避免外部光源造成的反光，保留烟盒的大部分特征；对灯带进行遮挡后会减少对最内侧的烟盒造成的反光，并且眼镜直视的时候不刺眼，因此建议采用照度为400lux的灯带。

# 海康HDR USB摄像头测试

摄像头参数：广角130°

1. 原始光照（373）：

![hk_hdr_1](pic/test_hdr_1.png)

2. 蓝光干扰

![hk_hdr_2](pic/test_hdr_2.png)

3. 白光干扰

![hk_hdr_3](pic/test_hdr_3.png)

4. 粉光干扰

![hk_hdr_4](pic/test_hdr_4.png)

5. 红光干扰

![hk_hdr_5](pic/test_hdr_5.png)

6. 黄光干扰

![hk_hdr_6](pic/test_hdr_6.png)

7. 绿光干扰

![hk_hdr_7](pic/test_hdr_7.png)

8. 外部关灯

![hk_test_8](pic/test_hdr_8.png)



结论：

HDR摄像头的成像效果偏白，但**没有反光**，比较适用于检测模型；此外在外界多种光照近距离干扰的情况下整体成像没有发生明显变化，**对光照的鲁棒性较强**。不过由于测试用的灯带光照强度不高（200 lux），尚无法确定在外有强光时候的成像情况。